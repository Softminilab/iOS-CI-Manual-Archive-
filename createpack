# !bin/bash
 
# éœ€è¦æ›´æ”¹ new_name å­—æ®µå’Œ project_name project_nameå¯ä»¥ä½¿ç”¨ xcodebuild -list è·å–scheme
if [[ $1 ]]; then
	echo  ""
else 
	echo  "App name ä¸ºç©ºï¼ŒApp name ä¸èƒ½ä¸ºç©º"
fi

SECONDS=0
originProject_name=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`
# echo $originProject_name

infoPlistDic=./$originProject_name/Info.plist
# dateTime=`date +%Y%m%d` %H:%M:%S 
name_prefix=$1
new_name=${name_prefix}
# echo $new_name

# echo $infoPlistDic

origin_Name=`/usr/libexec/PlistBuddy -c "Print CFBundleDisplayName" $infoPlistDic`
version=`/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" $infoPlistDic`
scheme=`/usr/libexec/PlistBuddy -c "Print RootSchemes" $infoPlistDic`
CFBundleIdentifier="com.xxx.xx"

sed -i '' 's/PRODUCT_BUNDLE_IDENTIFIER = .*;/PRODUCT_BUNDLE_IDENTIFIER = com.xxx.xx;/g' ${originProject_name}.xcodeproj/project.pbxproj
sed -i '' 's/CODE_SIGN_STYLE = .*;/CODE_SIGN_STYLE = Manual;/g' ${originProject_name}.xcodeproj/project.pbxproj
sed -i '' 's/ProvisioningStyle = .*;/ProvisioningStyle = Manual;/g' ${originProject_name}.xcodeproj/project.pbxproj
sed -i '' 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = TeamId;/g' ${originProject_name}.xcodeproj/project.pbxproj

echo "\033[36m ~~~~~~~~~~~~~~~~~~~~~~~"
echo "\033[36m App nameï¼š${new_name}"
echo "\033[36m App versionï¼š${version}"
echo "\033[36m ~~~~~~~~~~~~~~~~~~~~~~~\n"

if [ -e $infoPlistDic ] ; then
	/usr/libexec/PlistBuddy -c "set :CFBundleDisplayName ${new_name}" $infoPlistDic
	/usr/libexec/PlistBuddy -c "set :CFBundleIdentifier ${CFBundleIdentifier}" $infoPlistDic
	# sed -i '' 's/'${origin_Name}'/'${new_name}'/g' $infoPlistDic
else
	exit 0
fi

project_name=$scheme
scheme_name=$scheme
build_configuration="Release"
archive_name=${new_name}

if [ -d ${archive_name} ] ; then
rm -rf $archive_name
fi

mkdir $archive_name

archive_dir=./${archive_name}
exportPlist=$HOME/Documents/GitLab/Shell/AdHocExportOptionsPlist.plist
xcarchiveDir=$archive_dir/${new_name}.xcarchive
codeSign="iPhone Distribution: xxxx xxx (xxxx)"
# PROVISIONING_PROFILE å¯ä»¥ç”¨ /usr/bin/security cms -D -i å¯¼å‡ºç»“æœï¼Œåé¢è·Ÿä¸€ä¸ª xxx.mobileprovision æ–‡ä»¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä½äº $HOME/Library/MobileDevice/Provisioning Profiles ç›®å½•ä¸‹

PROVISIONING_PROFILE="xxxx-xxx-xxx-xxx-xxxxx"
ARCHSType="armv7 arm64"
teamid="teamId"


echo "\033[32m~~~~~~~~~~ æ¸…ç†é¡¹ç›® ~~~~~~~~~~~~~\n"
xcodebuild clean -workspace ${project_name}.xcworkspace \
                 -scheme ${scheme_name} \
                 -configuration ${build_configuration} > /dev/null 2>&1

echo "\033[32m~~~~~~~~~~ æ¸…ç†å®Œæˆ ~~~~~~~~~~~~~\n"
echo 
echo "\033[35m~~~~~~~~~~ æ‰“åŒ…å¼€å§‹ ~~~~~~~~~~~~~ \n"
echo

# IDEBuildOperationMaxNumberOfConcurrentCompileTasks ä»å­—é¢æ„æ€å°±çŸ¥é“å•¥æ„æ€
# å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæ˜¯æœ‰ä¸¤å±‚ï¼ŒåŸºå±‚æ˜¯ä¸€ä¸ªpodæ„æˆçš„ç§æœ‰é¡¹ç›®ï¼Œä¸Šå±‚ç»§æ‰¿åº•å±‚çš„æ§ä»¶ä»¥åŠé¡µé¢
# æ‰€ä»¥åœ¨ç¼–è¯‘æ˜¯å¦‚æœä¸æŒ‡å®šï¼Œxcodebuild complie å¯èƒ½åŒæ—¶æ‰¾åˆ°ä¸¤ä¸ªåå­—ä¸€æ ·çš„æ–‡ä»¶ï¼ˆä¸€ä¸ªä½äºpodä¸­ï¼Œä¸€ä¸ªä½äºæ­£åœ¨çš„é¡¹ç›®ä¸­ï¼‰ï¼Œä¼šé€ æˆæ‰“åŒ…ä¸é€šè¿‡
# å¦‚æœæŒ‡å®šï¼Œå°±æ˜¯ä¼šé€ æˆ complieé€Ÿåº¦æ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯ä¼šæŠ±ç€åœ¨ complie è¿‡ç¨‹ä¸ä¼šå‡ºç°é—®é¢˜
xcodebuild archive -workspace ${project_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${build_configuration} \
-archivePath ${xcarchiveDir} \
CODE_SIGN_IDENTITY="${codeSign}" \
PROVISIONING_PROFILE="${PROVISIONING_PROFILE}" \
-IDEBuildOperationMaxNumberOfConcurrentCompileTasks=1 \
-allowProvisioningUpdates > /dev/null 2>&1

if [ -d "$xcarchiveDir" ] ; then
echo 
echo "\033[32m~~~~~~~~~~ æ‰“åŒ…æˆåŠŸ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ~~~~~~~~~~~~~\n"
else
echo 
echo "\033[31m~~~~~~~~~~ æ‰“åŒ…å¤±è´¥ ~~~~~~~~~~~~~\n"
exit 0
echo 
fi

# xcodebuild -exportArchive -archivePath <xcarchivepath> -exportPath <destinationpath> -exportOptionsPlist <plistpath>

echo "\033[35m~~~~~~~~~~ å¯¼æˆ ipa ~~~~~~~~~~~~~\n"
xcodebuild  -exportArchive \
            -archivePath ${xcarchiveDir} \
            -exportPath ${archive_dir} \
            -exportOptionsPlist ${exportPlist} \
            -allowProvisioningUpdates > /dev/null 2>&1

path=${archive_name}/${scheme_name}.ipa
replacepath=${archive_name}/${new_name}.ipa

if [ -f $path ] ; then
mv $path $replacepath
echo "\033[32m~~~~~~~~~~ å¯¼æˆipaæˆåŠŸ ~~~~~~~~~~~~~\n"
else 
echo "\033[31m~~~~~~~~~~ å¯¼æˆipaå¤±è´¥ ~~~~~~~~~~~~~\n"
exit 0
fi 
echo "\033[36;1mæ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s \033[0m"


echo "\033[32m~~~~~~~~~~ ä¸Šä¼ æœåŠ¡å™¨ ~~~~~~~~~~~~~\n"
FILE=${archive_name}/${new_name}.ipa
HOST='xxx.xxx.xxx.xxx'
USER='sftpuser'
PASSWD='123456'
REMOTE="/upload/"

lftp sftp://$USER:$PASSWD@$HOST  -e "cd ${REMOTE}; put ${FILE} ;bye"
